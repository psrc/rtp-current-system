---
title: "Activity Units Overlays"
format: html
editor: visual
execute: 
  echo: false
  warning: false
---

::: panel-tabset
## Analysis

### Microtransit Service Areas

The 2024 activity units layer was filtered for any areas \>= 7 units/acre to focus on areas supportive of transit services. That output was then overlaid against a series of Microtransit MOD and ADA layers to show that people who live in a transit supported area actually have transit access.

```{r setup}
library(tidyverse)
library(gt)
library(openxlsx)
library(leaflet)
library(sf)
```

```{r}
output_path <- "J:\\Staff\\Christy\\GIS\\popemp-density\\output"
df <- read.xlsx(file.path(output_path, "specialized-mod-overlay.xlsx"))

levels <- c("Community Transit (Zip Alderwood)", 
            "King County Metro (Metro Flex)",
            "Kitsap Transit (On Demand Service)",
            "Pierce Transit (Runner)",
            "Community Transit (Zip North Snohomish)",
            "King County Metro (Metro Flex Northshore)",
            "Outside Specialized Transportation Areas")

df2 <- df |> 
  mutate(label = factor(name, levels = levels)) |> 
  arrange(label)
```

```{r}
df_display <- df2 |> 
  gt(rowname_col = "name") |> 
  cols_hide(label) |> 
  tab_header(title = "Microtransit Service Areas by Agency",
             subtitle = "Activity Units in 2024") |> 
  tab_spanner(
    label = "2024",
    columns = c("population_2024", "jobs_2024", "total_au_2024")
  ) |> 
  tab_stubhead(label = "Agency") |> 
  cols_label(
    population_2024 = "Population",
    jobs_2024 = "Jobs",
    total_au_2024 = "Total Activity Units"
  ) |> 
  cols_align(
    align = "center",
    columns = c("population_2024", "jobs_2024", "total_au_2024")
  ) |> 
  fmt_number(
    columns = c("population_2024", "jobs_2024", "total_au_2024"),
    decimals = 0
  ) |> 
  tab_footnote(
    footnote = "Service launched in 2024",
    locations = cells_stub(rows = c(
      "Community Transit (Zip North Snohomish)", "King County Metro (Metro Flex Northshore)"))
    )

df_display
```

```{r, eval=FALSE}
df_display |> gtsave(file.path(output_path, "specialized-mod-overlay.png"), expand = 10)
```

### ADA 

There are significant overlaps between ADA layers. The table below summaries how many activity units are within and outside of a specific agency. There is also a total count of activity units inside the combined ADA coverage area.

```{r}
ada_df <- read.xlsx(file.path(output_path, "ada-overlay.xlsx"))

ada_levels <- c("King County Metro Access", 
                "Not in King County Metro Access",
            "Kitsap Transit ACCESS",
            "Not in Kitsap Transit ACCESS",
            "Pierce Transit SHUTTLE",
            "Not in Pierce Transit SHUTTLE",
            "Community Transit DART",
            "Not in Community Transit DART",
            "Everett Transit Paratransit",
            "Not in Everett Transit Paratransit",
            "Inside ADA Coverage",
            "Outside ADA Coverage")

ada_df2 <- ada_df |> 
  mutate(label = factor(name, levels = ada_levels)) |> 
  arrange(label)

```

```{r}
ada_df_display <- ada_df2 |> 
  gt(rowname_col = "name") |> 
  cols_hide(label) |> 
  tab_header(title = "ADA Coverage",
             subtitle = "Activity Units in 2024") |> 
  tab_spanner(
    label = "2024",
    columns = c("population_2024", "jobs_2024", "total_au_2024")
  ) |> 
  cols_label(
    population_2024 = "Population",
    jobs_2024 = "Jobs",
    total_au_2024 = "Total Activity Units"
  ) |> 
  cols_align(
    align = "center",
    columns = c("population_2024", "jobs_2024", "total_au_2024")
  ) |> 
  fmt_number(
    columns = c("population_2024", "jobs_2024", "total_au_2024"),
    decimals = 0
  ) |>
  tab_row_group(
    label = "Total",
    rows = 11:12
  )|>
  tab_row_group(
    label = "Agencies",
    rows = 1:10
  ) 
  

ada_df_display
```

```{r}
#| echo: false

wgs84 <- 4326
ada_proj_path <- "J:\\Staff\\Christy\\GIS\\popemp-ada"
ada_dis_shp <- st_read(dsn = file.path(ada_proj_path, "popemp-ada.gdb"), layer = "ada_all_diss") |> 
  st_transform(wgs84)

ada_map <- leaflet(ada_dis_shp) |> 
  addProviderTiles(providers$CartoDB.Positron) |> 
  addPolygons(weight = 1.0,
              opacity = 1,
              color = "#C388C2",
              dashArray = "3",
              fillOpacity = 0.7,
              highlight = highlightOptions(
                weight =1,
                color = "#76787A",
                dashArray ="",
                fillOpacity = 0.7,
                bringToFront = TRUE
              ),
              group = "ADA Coverage"
  ) |> 
  addLayersControl(overlayGroups = c("ADA Coverage"),
                  options = layersControlOptions(collapsed = TRUE))

ada_map
```


## Data Sources

-   `Puget Sound Regional Council\GIS - Sharing\Projects\Transportation\RTP\_2026\activity\_units\Activity\_Units_2026_RTP.gdb (peope_jobs_2024)`

-   `Puget Sound Regional Council\GIS - Sharing\Projects\Transportation\RTP\_2026\specialized transportation\\2023_2024_ADA Paratransit Coverage\\2023_2024_ADA Coverage\\2023_2024_ADA Coverage.gdb`

-   `Puget Sound Regional Council\GIS - Sharing\Projects\Transportation\RTP\_2026\mod\MODInventory.gdb`

    -   Copy is also located here `J:\Staff\Christy\GIS\popemp-density\popemp-density.gdb (Microtransit_northshore_nsno)`. This layer includes new areas launched in 2024.
:::
